<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link rel="stylesheet" href="../css/dash.css">
    <title>Document</title>
</head>

<body>
    <header id="menu-lateral">
        <div class="logo">
            <a href="../index.html">
                <img src="../assets/icon/logo.png">
            </a>
            <nav>
                <li id="perfil">
                    <a href="../perfil.html">
                        <div class="svg-perfil">
                            <svg width="42" height="42" viewBox="0 0 42 42" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M20.9336 1.29492C9.91347 1.29492 0.933594 10.2748 0.933594 21.2949C0.933594 32.315 9.91347 41.2949 20.9336 41.2949C31.9537 41.2949 40.9336 32.315 40.9336 21.2949C40.9336 10.2748 31.9676 1.29492 20.9336 1.29492Z"
                                    fill="#02083e" stroke="#F9F4F2" stroke-width="0.7" />
                                <g clip-path="url(#clip0_4982_11701)">
                                    <path
                                        d="M22.9458 30.0792C24.3488 29.1235 25.8982 26.7689 26.1544 24.4062C23.3688 24.394 20.5587 23.7921 16.2033 23.8572C15.8577 23.8613 15.5201 23.8613 15.1948 23.8572C15.3493 26.8015 16.7523 28.8063 18.5417 30.0832C18.4237 31.4781 17.22 32.3321 16.3823 32.8486C14.8044 33.8205 12.096 34.1621 10.1562 36.1547C13.2713 38.245 17.0207 39.469 21.0548 39.469C24.784 39.469 28.2691 38.4239 31.2377 36.6143C30.4366 35.8131 28.6188 34.5321 25.6257 33.2146C24.5196 32.629 22.9784 31.1894 22.9499 30.0792H22.9458Z"
                                        fill="white" />
                                    <path
                                        d="M36.4998 19.9329C36.4998 19.9329 35.0643 20.1322 33.7955 20.2135C28.5699 20.4575 29.3466 20.608 27.4597 19.2863C25.5728 17.9646 25.2393 14.9635 24.9262 13.8939C24.4016 12.6333 22.474 9.9737 22.474 9.9737L21.9819 7.35885C21.8721 7.06605 23.6981 4.5 23.6981 4.5C23.6981 4.5 20.8636 5.49226 19.9405 6.29746C19.0174 7.10265 17.1101 10.3926 17.1101 10.3926L16.8458 13.3815L14.1984 18.9854C14.1984 18.9854 11.6649 19.8963 9.93654 19.7702C7.90729 19.6198 5.50391 18.8674 5.50391 18.8674C7.90729 21.7222 10.7133 22.9666 16.431 22.8812C23.0352 22.7877 26.0892 24.2313 30.8919 22.7999C35.6906 21.3684 36.5039 19.9329 36.5039 19.9329H36.4998Z"
                                        fill="white" />
                                </g>
                                <defs>
                                    <clipPath id="clip0_4982_11701">
                                        <rect width="31" height="34.965" fill="white" transform="translate(5.5 4.5)" />
                                    </clipPath>
                                </defs>
                            </svg>
                        </div>
                    </a>
                </li>
                <h3 class="hello"><span id="b_usuario">usuário</span></h3>
                <ul>
                    <li id="menu-quiz">
                        <span class="material-symbols-outlined">
                            quiz
                        </span>
                        <a href="../quiz.html">Quiz</a>
                    </li>
                    <li class="atual" id="dashboard">
                        <span class="material-symbols-outlined">
                            monitoring
                        </span>
                        <a href="../dashboard/dashboardHarryPotter.html">Dashboard</a>
                    </li>
                    <li  id="materias">
                        <span class="material-symbols-outlined">
                            menu_book
                        </span>
                        <a href="../materias.html">Matérias</a>
                    </li>
                    <li id="sair">
                        <span class="material-symbols-outlined">
                            logout
                        </span>
                        <a onclick="limparSessao()">Sair</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>
    <main id="conteudo">
        <div class="graficos">
            <div class="grafico-box">
                <h2 class="grafico-titulo">Distribuição das Casas</h2>
                <canvas id="grafico-casas" class="grafico-canvas" width="200" height="200"></canvas>
                <div id="kpi-container" style="text-align: center; margin: 30px auto; display: none;">
                    <div class="box-kpi1">
                        <p id="kpi-totalBruxos" style="font-size: 18px;"></p>
                    </div>
                    <div class="box-kpi2">
                        <p id="kpi-casaPopular" style="font-size: 18px;"></p>
                    </div>
                    <div class="box-kpi3">
                        <p id="kpi-totalCasaPopular" style="font-size: 18px;"></p>
                    </div>
                </div>
            </div>
            <div class="grafico-box">
                <h2 class="graficoAreaMagica-titulo">Distribuição das Preferências das Áreas Mágicas em cada casa</h2>
                <canvas id="grafico-areaMagica" class="grafico-canvas" width="400" height="400"></canvas>
            </div>
        </div>
    </main>



    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>

        b_usuario.innerHTML = sessionStorage.NOME_USUARIO;


        //CRIAR FUNÇÃO PARA NÃO APARECER O ICONE DO QUIZ DEPOIS QUE ELE FEZ O QUIZ E NÃO APARECER O ICONE DO PERFIL ANTES DELE FAZER O QUIZ
        function exibirMenuLateral() {
            var idCasa = sessionStorage.ID_CASA;
            var quiz = document.getElementById('menu-quiz');
            var perfil = document.getElementById('perfil');

            if (idCasa == null || idCasa == "null" || idCasa == undefined) {
                quiz.innerHTML = `
        <span class="material-symbols-outlined">
            quiz
            </span>
            <a href="../quiz.html">Quiz</a>
            `;

                perfil.innerHTML = ``;
            } else {
                quiz.innerHTML = ``;
                perfil.innerHTML = `<a href="../perfil.html">
                            <div class="svg-perfil">
                                <svg width="42" height="42" viewBox="0 0 42 42" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M20.9336 1.29492C9.91347 1.29492 0.933594 10.2748 0.933594 21.2949C0.933594 32.315 9.91347 41.2949 20.9336 41.2949C31.9537 41.2949 40.9336 32.315 40.9336 21.2949C40.9336 10.2748 31.9676 1.29492 20.9336 1.29492Z"
                                        fill="#02083e" stroke="#F9F4F2" stroke-width="0.7" />
                                    <g clip-path="url(#clip0_4982_11701)">
                                        <path
                                            d="M22.9458 30.0792C24.3488 29.1235 25.8982 26.7689 26.1544 24.4062C23.3688 24.394 20.5587 23.7921 16.2033 23.8572C15.8577 23.8613 15.5201 23.8613 15.1948 23.8572C15.3493 26.8015 16.7523 28.8063 18.5417 30.0832C18.4237 31.4781 17.22 32.3321 16.3823 32.8486C14.8044 33.8205 12.096 34.1621 10.1562 36.1547C13.2713 38.245 17.0207 39.469 21.0548 39.469C24.784 39.469 28.2691 38.4239 31.2377 36.6143C30.4366 35.8131 28.6188 34.5321 25.6257 33.2146C24.5196 32.629 22.9784 31.1894 22.9499 30.0792H22.9458Z"
                                            fill="white" />
                                        <path
                                            d="M36.4998 19.9329C36.4998 19.9329 35.0643 20.1322 33.7955 20.2135C28.5699 20.4575 29.3466 20.608 27.4597 19.2863C25.5728 17.9646 25.2393 14.9635 24.9262 13.8939C24.4016 12.6333 22.474 9.9737 22.474 9.9737L21.9819 7.35885C21.8721 7.06605 23.6981 4.5 23.6981 4.5C23.6981 4.5 20.8636 5.49226 19.9405 6.29746C19.0174 7.10265 17.1101 10.3926 17.1101 10.3926L16.8458 13.3815L14.1984 18.9854C14.1984 18.9854 11.6649 19.8963 9.93654 19.7702C7.90729 19.6198 5.50391 18.8674 5.50391 18.8674C7.90729 21.7222 10.7133 22.9666 16.431 22.8812C23.0352 22.7877 26.0892 24.2313 30.8919 22.7999C35.6906 21.3684 36.5039 19.9329 36.5039 19.9329H36.4998Z"
                                            fill="white" />
                                    </g>
                                    <defs>
                                        <clipPath id="clip0_4982_11701">
                                            <rect width="31" height="34.965" fill="white"
                                                transform="translate(5.5 4.5)" />
                                        </clipPath>
                                    </defs>
                                </svg>
                            </div>
                        </a>`;
            }
        }
        exibirMenuLateral();


        function limparSessao() {
            sessionStorage.clear();
            window.location = "../login.html"
        }

        let graficoCasas;

        function atualizarGraficoBarras(porcentagens) {
            const ctx = document.getElementById('grafico-casas').getContext('2d');

            if (graficoCasas) {
                graficoCasas.destroy();
            }

            graficoCasas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Grifinoria', 'Corvinal', 'LufaLufa', 'Sonserina'],
                    datasets: [{
                        label: "Porcentagem(%) de Pessoas por Casa",
                        data: [
                            porcentagens.Grifinoria,
                            porcentagens.Corvinal,
                            porcentagens.LufaLufa,
                            porcentagens.Sonserina
                        ],
                        backgroundColor: ['rgba(255, 0, 0, 0.7)', 'rgba(0, 0, 255, 0.7)', 'rgba(255, 215, 0, 0.7)', 'rgba(0, 128, 0, 0.7)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10,
                                max: 100
                            }
                        }
                    }
                }
            });

        }

        function atualizarGrafico() {
            fetch("/quiz/distribuicao", {
                method: 'GET',
                cache: 'no-store'
            })
                .then(response => response.json())
                .then(dados => {
                    const total = dados.reduce((acc, item) => acc + item.total_usuarios, 0);
                    const porcentagens = {
                        Grifinoria: 0,
                        Corvinal: 0,
                        LufaLufa: 0,
                        Sonserina: 0
                    };

                    let casaMaisPopular = '';
                    let maiorValor = 0;

                    dados.forEach(item => {
                        let nome = item.casa;
                        let totalCasa = item.total_usuarios;
                        let percent = ((item.total_usuarios / total) * 100).toFixed(2);

                        if (nome == "Grifinoria") porcentagens.Grifinoria = percent;
                        else if (nome == "Corvinal") porcentagens.Corvinal = percent;
                        else if (nome == "LufaLufa") porcentagens.LufaLufa = percent;
                        else if (nome == "Sonserina") porcentagens.Sonserina = percent;

                        if (totalCasa > maiorValor) {
                            maiorValor = totalCasa;
                            casaMaisPopular = nome;
                        }
                    });

                    atualizarKPI(total, casaMaisPopular, maiorValor)
                    atualizarGraficoBarras(porcentagens);
                })
                .catch(erro => {
                    console.error("Erro ao obter dados do gráfico:", erro);
                });
        }

        function atualizarKPI(total, casaMaisPopular, maiorValor) {

            //Atualização da KPI
            var container = document.getElementById('kpi-container')
            container.style.display = 'block';

            document.getElementById('kpi-totalBruxos').innerHTML = `Total de bruxos na escola: <strong>${total}</strong>`;
            document.getElementById('kpi-casaPopular').innerHTML = `Casa mais popular: <strong>${casaMaisPopular}</strong>`;
            document.getElementById('kpi-totalCasaPopular').innerHTML = `Quantidade de bruxos na casa mais popular: <strong>${maiorValor}</strong>`;

        }


        function agendarAtualizacaoGrafico() {
            if (proximaAtualizacao) {
                clearTimeout(proximaAtualizacao);
            }

            proximaAtualizacao = setTimeout(() => {
                atualizarGrafico()
            }, 500)
        }

        //Segundo gráfico
        function graficoInteressesAreaMagica() {
            fetch("/quiz/interesses", {
                method: 'GET',
                cache: 'no-store'
            })

                .then(res => res.json())
                .then(dados => {
                    //labels
                    const areas = ["Herbologia", "Magizologia", "Feitiços", "Poções"];
                    const casas = ["Grifinoria", "Corvinal", "Sonserina", "LufaLufa"];

                    const dadosPorCasa = {
                        Grifinoria: [0, 0, 0, 0],
                        Corvinal: [0, 0, 0, 0],
                        Sonserina: [0, 0, 0, 0],
                        LufaLufa: [0, 0, 0, 0]
                    };

                    // datas
                    dados.forEach(item => {
                        const indiceAreaMagicas = areas.indexOf(item.areaMagica);

                        if (indiceAreaMagicas >= 0) {
                            dadosPorCasa[item.casa][indiceAreaMagicas] = item.total_interesse;
                        }
                    });

                    const coresPorCasa = {
                        Grifinoria: 'rgba(255, 0, 0, 0.4)',
                        Corvinal: 'rgba(0, 0, 255, 0.4)',
                        Sonserina: 'rgba(0, 128, 0, 0.4)',
                        LufaLufa: 'rgba(255, 215, 0, 0.4)'
                    };

                    const bordaPorCasa = {
                        Grifinoria: 'rgb(139, 0, 0)',
                        Corvinal: 'rgb(0, 0, 139)',
                        Sonserina: 'rgb(0, 100, 0)',
                        LufaLufa: 'rgba(128, 128, 0)'
                    };

                    const datasets = casas.map(casa => ({
                        label: casa,
                        data: dadosPorCasa[casa],
                        fill: true,
                        tension: 0.1,
                        backgroundColor: coresPorCasa[casa],
                        borderColor: bordaPorCasa[casa],
                        borderDash: [3, 2]
                    }));

                    const ctx = document.getElementById('grafico-areaMagica').getContext('2d');
                    new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: areas,
                            datasets: datasets,
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: "Preferências das Casas por Áreas Mágicas"
                                }
                            },
                            scales: {
                                r: {
                                    suggestedMin: true,
                                    // suggestedMax: 10,

                                }
                            }
                        }

                    });

                })
                .catch(error => console.error("Erro ao buscar dados:", error));
        }

        window.onload = function () {

            atualizarGrafico();
            graficoInteressesAreaMagica();
        };


    </script>
</body>

</html>