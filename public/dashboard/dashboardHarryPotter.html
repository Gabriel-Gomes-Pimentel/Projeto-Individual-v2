<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link rel="stylesheet" href="../css/dash.css">
    <title>Document</title>
</head>

<body>
    <header id="menu-lateral">
        <div class="logo">
            <a href="../index.html">
                <img src="../assets/icon/logo.png">
            </a>
            <nav>
                <h3 class="hello">Olá, <span id="b_usuario">usuário</span>!</h3>
                <ul>
                    <li class="atual" id="dashboard">
                        <span class="material-symbols-outlined">
                            monitoring
                        </span>
                        <a href="../dashboard/dashboardHarryPotter.html">Dashboard</a>
                    </li>
                    <li id="distribuicaoCasas">
                        <span class="material-symbols-outlined">
                            person
                        </span>
                        <a href="./casa.html">Perfil</a>
                    </li>
                    <li id="menu-quiz">
                        <span class="material-symbols-outlined">
                            quiz
                        </span>
                        <a href="../quiz.html">Quiz</a>
                    </li>
                    <li id="sair">
                        <span class="material-symbols-outlined">
                            logout
                        </span>
                        <a onclick="limparSessao()">Sair</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>
    <main id="conteudo">
        <h2 class="grafico-titulo">Distribuição das Casas em %</h2>
        <div class="graficos">
            <div class="grafico-box">
                <canvas id="grafico-casas" class="grafico-canvas" width="600" height="400"></canvas>
                <div id="kpi-container" style="text-align: center; margin: 30px auto; display: none;">
                    <p id="kpi-totalBruxos" style="font-size: 18px;"></p>
                    <p id="kpi-casaPopular" style="font-size: 18px;"></p>
                    <p id="kpi-totalCasaPopular" style="font-size: 18px;"></p>
                </div>
            </div>
            <div class="grafico-box"></div>
            <canvas id="grafico-areaMagica" class="grafico-canvas" width="600" height="400"></canvas>
        </div>
    </main>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;


    //CRIAR FUNÇÃO PARA O DISPLAY SER NONE DEPOIS QUE ELE FEZ O QUIZ
    var idCasa = sessionStorage.ID_CASA

    function limparSessao() {
        sessionStorage.clear();
        window.location = "../login.html"
    }

    let graficosCasas;

    function agendarAtualizacaoGrafico() {
        if (proximaAtualizacao) {
            clearTimeout(proximaAtualizacao);
        }

        proximaAtualizacao = setTimeout(() => {
            atualizarGrafico()
        }, 500)
    }

    let graficoCasas;

    function atualizarGraficoBarras(porcentagens) {
        const ctx = document.getElementById('grafico-casas').getContext('2d');

        if (graficoCasas) {
            graficoCasas.destroy();
        }


        graficoCasas = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Grifinoria', 'Corvinal', 'LufaLufa', 'Sonserina'],
                datasets: [{
                    label: "Porcentagem(%) de Pessoas por Casa",
                    data: [
                        porcentagens.Grifinoria,
                        porcentagens.Corvinal,
                        porcentagens.LufaLufa,
                        porcentagens.Sonserina
                    ],
                    backgroundColor: ['rgba(255, 0, 0, 0.7)', 'rgba(0, 0, 255, 0.7)', 'rgba(255, 215, 0, 0.7)', 'rgba(0, 128, 0, 0.7)'],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 10,
                            max: 100
                        }
                    }
                }
            }
        });

    }

    function atualizarGrafico() {
        fetch("/quiz/distribuicao", { cache: 'no-store' })
            .then(response => response.json())
            .then(dados => {
                const total = dados.reduce((acc, item) => acc + item.total_resultado, 0);
                const porcentagens = {
                    Grifinoria: 0,
                    Corvinal: 0,
                    LufaLufa: 0,
                    Sonserina: 0
                };

                let casaMaisPopular = '';
                let maiorValor = 0;

                dados.forEach(item => {
                    let nome = item.casa;
                    let totalCasa = item.total_resultado;
                    let percent = ((item.total_resultado / total) * 100).toFixed(2);

                    if (nome == "Grifinoria") porcentagens.Grifinoria = percent;
                    else if (nome == "Corvinal") porcentagens.Corvinal = percent;
                    else if (nome == "LufaLufa") porcentagens.LufaLufa = percent;
                    else if (nome == "Sonserina") porcentagens.Sonserina = percent;

                    if (totalCasa > maiorValor) {
                        maiorValor = totalCasa;
                        casaMaisPopular = nome;
                    }
                });

                //Atualização da KPI
                document.getElementById('kpi-container').style.display = 'block';
                document.getElementById('kpi-totalBruxos').innerHTML = `Total de bruxos na escola: <strong>${total}</strong>`;
                document.getElementById('kpi-casaPopular').innerHTML = `Casa mais popular: <strong>${casaMaisPopular}</strong>`;
                document.getElementById('kpi-totalCasaPopular').innerHTML = `Quantidade de bruxos na casa mais popular: <strong>${maiorValor}</strong>`;

                atualizarGraficoBarras(porcentagens);
            })
            .catch(erro => {
                console.error("Erro ao obter dados do gráfico:", erro);
            });
    }

    window.onload = atualizarGrafico;
</script>