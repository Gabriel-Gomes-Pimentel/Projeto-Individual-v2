<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz</title>
    <link rel="stylesheet" href="./css/quiz.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link href="https://fonts.cdnfonts.com/css/harry-potter" rel="stylesheet">
</head>

<body>
    <header id="menu-lateral">
        <div class="logo">
            <a href="../index.html">
                <img src="../assets/icon/logo.png">
            </a>
            <nav>
                <h3 class="hello">Olá, <span id="b_usuario">usuário</span>!</h3>
                <ul>
                    <li class="atual" id="menu-quiz">
                        <span class="material-symbols-outlined">
                            quiz
                        </span>
                        <a href="../quiz.html">Quiz</a>
                    </li>
                    <li id="dashboard">
                        <span class="material-symbols-outlined">
                            monitoring
                        </span>
                        <a href="../dashboard/dashboardHarryPotter.html">Dashboard</a>
                    </li>
                    <li id="perfil">
                        <span class="material-symbols-outlined">
                            person
                        </span>
                        <a href="../perfil.html">Perfil</a>
                    </li>
                    <li id="sair">
                        <span class="material-symbols-outlined">
                            logout
                        </span>
                        <a onclick="limparSessao()">Sair</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>
    <div id="conteudo" class="container-quiz">
        <button id="botao-iniciar-quiz" class="botao-iniciar" onclick="iniciarQuiz()">Descubra a sua Casa</button>

        <div id="quiz" class="quiz-container" style="display: none;">
            <div id="container-pergunta">
                <span id="numero-pergunta" class="numero-pergunta"></span>
                <p id="texto-pergunta" class="texto-pergunta"></p>
            </div>

            <div id="carrossel-container" style="display: none;">
                <button onclick="voltarOpcao()"><svg xmlns="http://www.w3.org/2000/svg" height="24px"
                        viewBox="0 -960 960 960" width="24px" fill="#fff">
                        <path d="M560-240 320-480l240-240 56 56-184 184 184 184-56 56Z" />
                    </svg></button>
                <label id="opcao-atual" class="carrosel-item" data-valor="A">
                    <img id="imagem-opcao" src="" style="max-width: 300px;"><br>
                    <span id="texto-opcao" class="texto-opcao"></span>
                </label><br>
                <button onclick="avancarOpcao()"><svg xmlns="http://www.w3.org/2000/svg" height="24px"
                        viewBox="0 -960 960 960" width="24px" fill="#fff">
                        <path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z" />
                    </svg>
                </button>
            </div>

            <button id="botao-proxima" class="botao-proxima" onclick="proximaPergunta()">Pergunta Seguinte</button>
        </div>
        <div id="resultado" class="resultado" style="display: none">
            <h2>Resultado Final</h2>
            <p id="mensagem-resultado" class="mensagem-resultado"></p>
            <p><strong><span id="nome-casa" class="nome-casa"></span> </strong></p>
            <div class="exit" id="exit">
                <img src="./assets/icon/Plataforma934.png" alt="Plataforma 9 3/4">
            </div>
        </div>
    </div>
    <script>
        const perguntas = [{

            pergunta: "Se você pudesse escolher apenas uma área de magia para praticar qual você escolheria?",
            opcoes: {
                A: { texto: "Herbologia", imagem: "./assets/imgs/herbology-area.webp" },
                B: { texto: "Magizologia", imagem: "./assets/imgs/animologia.png" },
                C: { texto: "Feitiços", imagem: "./assets/imgs/speel-area.webp" },
                D: { texto: "Poções", imagem: "./assets/imgs/potions-area.webp" }
            },
            respostas: {
                A: "LufaLufa",
                B: "Grifinoria",
                C: "Corvinal",
                D: "Sonserina"
            }
        },
        {
            pergunta: "Dia ou Noite?",
            opcoes: {
                A: { texto: "Dia", imagem: "./assets/imgs/dia-noite.png" },
                B: { texto: "Noite", imagem: "./assets/imgs/dia-noite.png" }
            },

            respostas: {
                A: "Grifinoria",
                B: "Sonserina"
            }
        },

        {
            pergunta: "Fazer trilha ou Nadar?",
            opcoes: {
                A: { texto: "Nadar", imagem: "./assets/imgs/fazer trilha-nadar.png" },
                B: { texto: "Trilha", imagem: "./assets/imgs/fazer trilha-nadar.png" }
            },

            respostas: {
                A: "LufaLufa",
                B: "Corvinal"
            }
        },

        {
            pergunta: "Se você visse um desconhecido sendo assaltado na sua frente em uma rua deserta:",
            opcoes: {
                A: { texto: "Tiraria a varinha do bolso e lançaria uma maldição no ladrão", imagem: "./assets/imgs/cenario-assustador.png" },
                B: { texto: "Fingiria que nada aconteceu", imagem: "./assets/imgs/cenario-assustador.png" },
                C: { texto: "Ligaria para a polícia", imagem: "./assets/imgs/cenario-assustador.png" },
                D: { texto: "Acalmaria a vítima depois do assalto", imagem: "./assets/imgs/cenario-assustador.png" }
            },
            respostas: {
                A: "Grifinoria",
                B: "Sonserina",
                C: "Corvinal",
                D: "LufaLufa"
            }
        }
        ];

        let indicePerguntaAtual = 0;
        let pontoCasas = {
            Grifinoria: 0,
            Corvinal: 0,
            LufaLufa: 0,
            Sonserina: 0
        };

        let opcoesAtual = 0;
        let letrasAtuais = [];

        let proximaAtualizacao = null;

        function iniciarQuiz() {
            document.getElementById('botao-iniciar-quiz').style.display = 'none';
            document.getElementById('quiz').style.display = 'block';
            carregarPergunta();
        }

        function carregarPergunta() {
            const perguntaAtual = perguntas[indicePerguntaAtual];
            document.getElementById('numero-pergunta').innerHTML = `Pergunta ${indicePerguntaAtual + 1} de ${perguntas.length}`;
            document.getElementById('texto-pergunta').innerHTML = perguntaAtual.pergunta;

            letrasAtuais = Object.keys(perguntaAtual.opcoes);
            opcoesAtual = 0;

            const carrossel = document.getElementById('carrossel-container');
            carrossel.style.display = 'flex';

            mostrarOpcaoAtual();

            document.getElementById('carrossel-container').style.display = 'flex';
        }

        function mostrarOpcaoAtual() {
            const letra = letrasAtuais[opcoesAtual];
            const opcao = perguntas[indicePerguntaAtual].opcoes[letra];

            document.getElementById("imagem-opcao").src = opcao.imagem;
            document.getElementById("texto-opcao").innerHTML = opcao.texto;
        }

        function voltarOpcao() {
            if (opcoesAtual > 0) {
                opcoesAtual--;
                mostrarOpcaoAtual();
            }
        }

        function avancarOpcao() {
            if (opcoesAtual < letrasAtuais.length - 1) {
                opcoesAtual++;
                mostrarOpcaoAtual();
            }
        }

        let areaMagicaFavorita = '';

        function proximaPergunta() {
            const letraSelecionada = letrasAtuais[opcoesAtual];
            const casa = perguntas[indicePerguntaAtual].respostas[letraSelecionada];

            pontoCasas[casa]++;

            if (indicePerguntaAtual == 0) {
                areaMagicaFavorita = perguntas[indicePerguntaAtual].opcoes[letraSelecionada].texto;
            }

            indicePerguntaAtual++
            if (indicePerguntaAtual < perguntas.length) {
                carregarPergunta();
            } else {
                document.getElementById('carrossel-container').style.display = 'none';
                mostrarResultado();
            }
        }

        // Qual casa o usuario foi selecionado
        let idCasa = 0;

        // Qual é a área mágica favorita do usuário
        let idAreaMagica = 0;

        function mostrarResultado() {
            document.getElementById('quiz').style.display = 'none';
            document.getElementById('resultado').style.display = 'block';

            let casas = ["Grifinoria", "Corvinal", "LufaLufa", "Sonserina"];
            let maiorPontuacao = 0;
            let casaSelecionada = '';

            for (let i = 0; i < casas.length; i++) {
                let casaAtual = casas[i];
                if (pontoCasas[casaAtual] > maiorPontuacao) {
                    maiorPontuacao = pontoCasas[casaAtual];
                }
            }

            let casasEmpatadas = [];
            for (let i = 0; i < casas.length; i++) {
                let casaAtual = casas[i];
                if (pontoCasas[casaAtual] == maiorPontuacao) {
                    casasEmpatadas.push(casaAtual);
                }
            }

            // NÚMERO ALEATÓRIO PARA ESCOLHER UMA CASA ENTRE AS EMPATADAS
            let indiceAleatorio = Math.floor(Math.random() * casasEmpatadas.length);
            casaSelecionada = casasEmpatadas[indiceAleatorio]


            // DEFINE O ID DA SUA CASA CORRESPONDETE O RESULTADO DO QUIZ
            if (casaSelecionada == 'Grifinoria') {
                idCasa = 1;
            } else if (casaSelecionada == 'Corvinal') {
                idCasa = 2;
            }
            else if (casaSelecionada == 'Sonserina') {
                idCasa = 3;
            }
            else if (casaSelecionada == 'LufaLufa') {
                idCasa = 4;
            }

            //DEFINE O ID DA SUA ÁREA MÁGICA FAVORITA CORRESPONDETE O RESULTADO DO QUIZ
            if (areaMagicaFavorita == 'Herbologia') {
                idAreaMagica = 1;
            } else if (areaMagicaFavorita == 'Magizologia') {
                idAreaMagica = 2;
            } else if (areaMagicaFavorita == 'Feitiços') {
                idAreaMagica = 3;
            } else if (areaMagicaFavorita == 'Poções') {
                idAreaMagica = 4;
            }

            document.getElementById('nome-casa').innerHTML = casaSelecionada;
            document.getElementById('mensagem-resultado').innerHTML = `Você foi selecionado para a casa <br><br>`;
            cadastrar();
        }

        function cadastrar() {
            console.log("ID do usuário no sessionStorage", sessionStorage.ID_USUARIO);
            const dados = {
                idUserServer: sessionStorage.ID_USUARIO,
                idCasaServer: idCasa,
                idAreaMagicaServer: idAreaMagica,
            }
            fetch("/quiz/cadastrar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(dados),
            })
                .then(function (resposta) {
                    if (!resposta.ok) {
                        throw new Error("Erro na requisição: " + resposta.status);
                    }
                    return resposta.json();
                })
                .then(function (dadosResposta) {
                    console.log('Pontuação cadastrada com sucesso', dadosResposta);
                })
                .catch((error) => {
                    console.error("Erro:", error);
                    alert("Erro ao cadastrar a pontuação. Tente novamente");
                });

        }

        //CRIAR FUNÇÃO PARA NÃO APARECER O ICONE DO QUIZ DEPOIS QUE ELE FEZ O QUIZ E NÃO APARECER O ICONE DO PERFIL ANTES DELE FAZER O QUIZ
        function exibirMenuLateral() {
            var idCasa = sessionStorage.ID_CASA;
            var quiz = document.getElementById('menu-quiz');
            var perfil = document.getElementById('perfil');

            if (idCasa == null || idCasa == "null" || idCasa == undefined) {
                quiz.innerHTML = `
        <span class="material-symbols-outlined">
            quiz
            </span>
            <a href="../quiz.html">Quiz</a>
            `;

                perfil.innerHTML = ``;
            } else {
                quiz.innerHTML = ``;
                perfil.innerHTML = `  <span class="material-symbols-outlined">
                                person
                            </span>
                            <a href="../perfil.html">Perfil</a>`;
            }
        }
        exibirMenuLateral();

    </script>
</body>

</html>