<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz</title>
    <link rel="stylesheet" href="./css/quiz.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link href="https://fonts.cdnfonts.com/css/harry-potter" rel="stylesheet">
</head>

<body>
    <header id="menu-lateral">
        <div class="logo">
            <a href="../index.html">
                <img src="../assets/icon/logo.png">
            </a>
            <nav>
                <li id="perfil">
                    <a href="../perfil.html">
                        <div class="svg-perfil">
                            <svg class="svg-perfil" width="42" height="42" viewBox="0 0 42 42" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M20.9336 1.29492C9.91347 1.29492 0.933594 10.2748 0.933594 21.2949C0.933594 32.315 9.91347 41.2949 20.9336 41.2949C31.9537 41.2949 40.9336 32.315 40.9336 21.2949C40.9336 10.2748 31.9676 1.29492 20.9336 1.29492Z"
                                    fill="#02083e" stroke="#F9F4F2" stroke-width="0.7" />
                                <g clip-path="url(#clip0_4982_11701)">
                                    <path
                                        d="M22.9458 30.0792C24.3488 29.1235 25.8982 26.7689 26.1544 24.4062C23.3688 24.394 20.5587 23.7921 16.2033 23.8572C15.8577 23.8613 15.5201 23.8613 15.1948 23.8572C15.3493 26.8015 16.7523 28.8063 18.5417 30.0832C18.4237 31.4781 17.22 32.3321 16.3823 32.8486C14.8044 33.8205 12.096 34.1621 10.1562 36.1547C13.2713 38.245 17.0207 39.469 21.0548 39.469C24.784 39.469 28.2691 38.4239 31.2377 36.6143C30.4366 35.8131 28.6188 34.5321 25.6257 33.2146C24.5196 32.629 22.9784 31.1894 22.9499 30.0792H22.9458Z"
                                        fill="white" />
                                    <path
                                        d="M36.4998 19.9329C36.4998 19.9329 35.0643 20.1322 33.7955 20.2135C28.5699 20.4575 29.3466 20.608 27.4597 19.2863C25.5728 17.9646 25.2393 14.9635 24.9262 13.8939C24.4016 12.6333 22.474 9.9737 22.474 9.9737L21.9819 7.35885C21.8721 7.06605 23.6981 4.5 23.6981 4.5C23.6981 4.5 20.8636 5.49226 19.9405 6.29746C19.0174 7.10265 17.1101 10.3926 17.1101 10.3926L16.8458 13.3815L14.1984 18.9854C14.1984 18.9854 11.6649 19.8963 9.93654 19.7702C7.90729 19.6198 5.50391 18.8674 5.50391 18.8674C7.90729 21.7222 10.7133 22.9666 16.431 22.8812C23.0352 22.7877 26.0892 24.2313 30.8919 22.7999C35.6906 21.3684 36.5039 19.9329 36.5039 19.9329H36.4998Z"
                                        fill="white" />
                                </g>
                                <defs>
                                    <clipPath id="clip0_4982_11701">
                                        <rect width="31" height="34.965" fill="white" transform="translate(5.5 4.5)" />
                                    </clipPath>
                                </defs>
                            </svg>
                        </div>
                    </a>
                </li>
                <h3 class="hello"><span id="b_usuario">usuário</span></h3>
                <ul>
                    <li class="atual" id="menu-quiz">
                        <span class="material-symbols-outlined">
                            quiz
                        </span>
                        <a href="../quiz.html">Quiz</a>
                    </li>
                    <li id="dashboard">
                        <span class="material-symbols-outlined">
                            monitoring
                        </span>
                        <a href="../dashboard/dashboardHarryPotter.html">Dashboard</a>
                    </li>
                    <li id="sair">
                        <span class="material-symbols-outlined">
                            logout
                        </span>
                        <a onclick="limparSessao()">Sair</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>
    <div id="conteudo" class="container-quiz">
        <button id="botao-iniciar-quiz" class="botao-iniciar" onclick="iniciarQuiz()">Descubra a sua Casa</button>

        <div id="quiz" class="quiz-container" style="display: none;">
            <div id="container-pergunta">
                <span id="numero-pergunta" class="numero-pergunta"></span>
                <p id="texto-pergunta" class="texto-pergunta"></p>
            </div>

            <div id="carrossel-container" style="display: none;">
                <button onclick="voltarOpcao()"><svg xmlns="http://www.w3.org/2000/svg" height="24px"
                        viewBox="0 -960 960 960" width="24px" fill="#fff">
                        <path d="M560-240 320-480l240-240 56 56-184 184 184 184-56 56Z" />
                    </svg></button>
                <label id="opcao-atual" class="carrosel-item" data-valor="A">
                    <img id="imagem-opcao" src="" style="max-width: 300px;"><br>
                    <span id="texto-opcao" class="texto-opcao"></span>
                </label><br>
                <button onclick="avancarOpcao()"><svg xmlns="http://www.w3.org/2000/svg" height="24px"
                        viewBox="0 -960 960 960" width="24px" fill="#fff">
                        <path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z" />
                    </svg>
                </button>
            </div>

            <button id="botao-proxima" class="botao-proxima" onclick="proximaPergunta()">Pergunta Seguinte</button>
        </div>
        <div id="resultado" class="resultado" style="display: none">
            <h2>Resultado Final</h2>
            <p id="mensagem-resultado" class="mensagem-resultado"></p>
            <p><strong><span id="nome-casa" class="nome-casa"></span> </strong></p>
        </div>
    </div>
    <script>
        const perguntas = [{

            pergunta: "Se você pudesse escolher apenas uma área de magia para praticar qual você escolheria?",
            opcoes: {
                A: { texto: "Herbologia", imagem: "./assets/imgs/herbology-area.webp" },
                B: { texto: "Magizologia", imagem: "./assets/imgs/animologia.png" },
                C: { texto: "Feitiços", imagem: "./assets/imgs/speel-area.webp" },
                D: { texto: "Poções", imagem: "./assets/imgs/potions-area.webp" }
            },
            respostas: {
                A: "LufaLufa",
                B: "Grifinoria",
                C: "Corvinal",
                D: "Sonserina"
            }
        },
        {
            pergunta: "Dia ou Noite?",
            opcoes: {
                A: { texto: "Dia", imagem: "./assets/imgs/dia-noite.png" },
                B: { texto: "Noite", imagem: "./assets/imgs/dia-noite.png" }
            },

            respostas: {
                A: "Grifinoria",
                B: "Sonserina"
            }
        },

        {
            pergunta: "Fazer trilha ou Nadar?",
            opcoes: {
                A: { texto: "Nadar", imagem: "./assets/imgs/fazer trilha-nadar.png" },
                B: { texto: "Trilha", imagem: "./assets/imgs/fazer trilha-nadar.png" }
            },

            respostas: {
                A: "Corvinal",
                B: "LufaLufa"
            }
        },

        {
            pergunta: "Se você visse um desconhecido sendo assaltado na sua frente em uma rua deserta:",
            opcoes: {
                A: { texto: "Tiraria a varinha do bolso e lançaria uma maldição no ladrão", imagem: "./assets/imgs/cenario-assustador.png" },
                B: { texto: "Fingiria que nada aconteceu", imagem: "./assets/imgs/cenario-assustador.png" },
                C: { texto: "Ligaria para a polícia", imagem: "./assets/imgs/cenario-assustador.png" },
                D: { texto: "Acalmaria a vítima depois do assalto", imagem: "./assets/imgs/cenario-assustador.png" }
            },
            respostas: {
                A: "Grifinoria",
                B: "Sonserina",
                C: "Corvinal",
                D: "LufaLufa"
            }
        }
        ];

        let indicePerguntaAtual = 0;
        let pontoCasas = {
            Grifinoria: 0,
            Corvinal: 0,
            LufaLufa: 0,
            Sonserina: 0
        };

        let opcoesAtual = 0;
        let letrasAtuais = [];

        let proximaAtualizacao = null;

        function iniciarQuiz() {
            document.getElementById('botao-iniciar-quiz').style.display = 'none';
            document.getElementById('quiz').style.display = 'block';
            carregarPergunta();
        }

        function carregarPergunta() {
            const perguntaAtual = perguntas[indicePerguntaAtual];
            document.getElementById('numero-pergunta').innerHTML = `Pergunta ${indicePerguntaAtual + 1} de ${perguntas.length}`;
            document.getElementById('texto-pergunta').innerHTML = perguntaAtual.pergunta;

            letrasAtuais = Object.keys(perguntaAtual.opcoes);
            opcoesAtual = 0;

            const carrossel = document.getElementById('carrossel-container');
            carrossel.style.display = 'flex';

            mostrarOpcaoAtual();

            document.getElementById('carrossel-container').style.display = 'flex';
        }

        function mostrarOpcaoAtual() {
            const letra = letrasAtuais[opcoesAtual];
            const opcao = perguntas[indicePerguntaAtual].opcoes[letra];

            document.getElementById("imagem-opcao").src = opcao.imagem;
            document.getElementById("texto-opcao").innerHTML = opcao.texto;
        }

        function voltarOpcao() {
            if (opcoesAtual > 0) {
                opcoesAtual--;
                mostrarOpcaoAtual();
            }
        }

        function avancarOpcao() {
            if (opcoesAtual < letrasAtuais.length - 1) {
                opcoesAtual++;
                mostrarOpcaoAtual();
            }
        }

        let areaMagicaFavorita = '';

        function proximaPergunta() {
            const letraSelecionada = letrasAtuais[opcoesAtual];
            const casa = perguntas[indicePerguntaAtual].respostas[letraSelecionada];

            console.log(`Pergunta ${indicePerguntaAtual + 1}: letra ${letraSelecionada} = ${casa}`);


            pontoCasas[casa]++;
            console.log(`Pontuação atual por casa:`, pontoCasas);

            if (indicePerguntaAtual == 0) {
                areaMagicaFavorita = perguntas[indicePerguntaAtual].opcoes[letraSelecionada].texto;
            }

            indicePerguntaAtual++
            if (indicePerguntaAtual < perguntas.length) {
                carregarPergunta();
            } else {
                document.getElementById('carrossel-container').style.display = 'none';
                mostrarResultado();
            }
        }

        // Qual casa o usuario foi selecionado
        let idCasa = 0;

        // Qual é a área mágica favorita do usuário
        let idAreaMagica = 0;

        function mostrarResultado() {
            document.getElementById('quiz').style.display = 'none';
            document.getElementById('resultado').style.display = 'block';

            let casas = ["Grifinoria", "Corvinal", "LufaLufa", "Sonserina"];
            let maiorPontuacao = 0;
            let casaSelecionada = '';

            for (let i = 0; i < casas.length; i++) {
                let casaAtual = casas[i];
                if (pontoCasas[casaAtual] > maiorPontuacao) {
                    maiorPontuacao = pontoCasas[casaAtual];
                }
            }

            let casasEmpatadas = [];
            for (let i = 0; i < casas.length; i++) {
                let casaAtual = casas[i];
                if (pontoCasas[casaAtual] == maiorPontuacao) {
                    casasEmpatadas.push(casaAtual);
                }
            }

            // NÚMERO ALEATÓRIO PARA ESCOLHER UMA CASA ENTRE AS EMPATADAS
            let indiceAleatorio = Math.floor(Math.random() * casasEmpatadas.length);
            casaSelecionada = casasEmpatadas[indiceAleatorio]


            // DEFINE O ID DA SUA CASA CORRESPONDETE O RESULTADO DO QUIZ
            if (casaSelecionada == 'Grifinoria') {
                idCasa = 1;
            } else if (casaSelecionada == 'Corvinal') {
                idCasa = 2;
            }
            else if (casaSelecionada == 'Sonserina') {
                idCasa = 3;
            }
            else if (casaSelecionada == 'LufaLufa') {
                idCasa = 4;
            }

            //DEFINE O ID DA SUA ÁREA MÁGICA FAVORITA CORRESPONDETE O RESULTADO DO QUIZ
            if (areaMagicaFavorita == 'Herbologia') {
                idAreaMagica = 1;
            } else if (areaMagicaFavorita == 'Magizologia') {
                idAreaMagica = 2;
            } else if (areaMagicaFavorita == 'Feitiços') {
                idAreaMagica = 3;
            } else if (areaMagicaFavorita == 'Poções') {
                idAreaMagica = 4;
            }

            document.getElementById('nome-casa').innerHTML = casaSelecionada;
            document.getElementById('mensagem-resultado').innerHTML = `Você foi selecionado para a casa <br><br>`;
            console.log(`Casa escolhida:`, casaSelecionada);
            console.log(`Pontuação final:`, pontoCasas);

            registrarRespostas();
            finalizarQuiz();

        }

        function registrarRespostas() {
            console.log("ID do usuário no sessionStorage", sessionStorage.ID_USUARIO);
            const dados = {
                idUserServer: sessionStorage.ID_USUARIO,
                idCasaServer: idCasa,
                idAreaMagicaServer: idAreaMagica,
            }
            fetch("/quiz/registrarRespostas", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(dados),
            })
                .then(function (resposta) {
                    if (!resposta.ok) {
                        throw new Error("Erro na requisição: " + resposta.status);
                    }
                    return resposta.json();
                })
                .then(function (dadosResposta) {
                    console.log('Pontuação cadastrada com sucesso', dadosResposta);
                })
                .catch((error) => {
                    console.error("Erro:", error);
                    alert("Erro ao registrar a pontuação. Tente novamente");
                });
        }

        function finalizarQuiz() {
            fetch(`/quiz/finalizarQuiz/${sessionStorage.ID_USUARIO}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idUserServer: sessionStorage.ID_USUARIO,
                    idCasaServer: idCasa,
                    idAreaMagicaServer: idAreaMagica
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Erro ao finalizar quiz");
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Quiz finalizado:", data);
                    sessionStorage.ID_CASA = idCasa;
                    sessionStorage.ID_AREA_MAGICA = idAreaMagica;
                    exibirMenuLateral();
                })
                .catch(error => {
                    console.error("Erro ao finalizar quiz:", error);
                });
        }

        b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

        //CRIAR FUNÇÃO PARA NÃO APARECER O ICONE DO QUIZ DEPOIS QUE ELE FEZ O QUIZ E NÃO APARECER O ICONE DO PERFIL ANTES DELE FAZER O QUIZ
        function exibirMenuLateral() {
            var idCasa = sessionStorage.ID_CASA;
            var quiz = document.getElementById('menu-quiz');
            var perfil = document.getElementById('perfil');

            if (idCasa == null || idCasa == "null" || idCasa == undefined) {
                quiz.innerHTML = `
       <li class="atual" id="menu-quiz">
                        <span class="material-symbols-outlined">
                            quiz
                        </span>
                        <a href="../quiz.html">Quiz</a>
                    </li>
            `;

                perfil.innerHTML = ``;
            } else {
                quiz.innerHTML = ``;
                perfil.innerHTML = `<a href="../perfil.html">
                        <div class="svg-perfil">
                            <svg width="42" height="42" viewBox="0 0 42 42" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M20.9336 1.29492C9.91347 1.29492 0.933594 10.2748 0.933594 21.2949C0.933594 32.315 9.91347 41.2949 20.9336 41.2949C31.9537 41.2949 40.9336 32.315 40.9336 21.2949C40.9336 10.2748 31.9676 1.29492 20.9336 1.29492Z"
                                    fill="#02083e" stroke="#F9F4F2" stroke-width="0.7" />
                                <g clip-path="url(#clip0_4982_11701)">
                                    <path
                                        d="M22.9458 30.0792C24.3488 29.1235 25.8982 26.7689 26.1544 24.4062C23.3688 24.394 20.5587 23.7921 16.2033 23.8572C15.8577 23.8613 15.5201 23.8613 15.1948 23.8572C15.3493 26.8015 16.7523 28.8063 18.5417 30.0832C18.4237 31.4781 17.22 32.3321 16.3823 32.8486C14.8044 33.8205 12.096 34.1621 10.1562 36.1547C13.2713 38.245 17.0207 39.469 21.0548 39.469C24.784 39.469 28.2691 38.4239 31.2377 36.6143C30.4366 35.8131 28.6188 34.5321 25.6257 33.2146C24.5196 32.629 22.9784 31.1894 22.9499 30.0792H22.9458Z"
                                        fill="white" />
                                    <path
                                        d="M36.4998 19.9329C36.4998 19.9329 35.0643 20.1322 33.7955 20.2135C28.5699 20.4575 29.3466 20.608 27.4597 19.2863C25.5728 17.9646 25.2393 14.9635 24.9262 13.8939C24.4016 12.6333 22.474 9.9737 22.474 9.9737L21.9819 7.35885C21.8721 7.06605 23.6981 4.5 23.6981 4.5C23.6981 4.5 20.8636 5.49226 19.9405 6.29746C19.0174 7.10265 17.1101 10.3926 17.1101 10.3926L16.8458 13.3815L14.1984 18.9854C14.1984 18.9854 11.6649 19.8963 9.93654 19.7702C7.90729 19.6198 5.50391 18.8674 5.50391 18.8674C7.90729 21.7222 10.7133 22.9666 16.431 22.8812C23.0352 22.7877 26.0892 24.2313 30.8919 22.7999C35.6906 21.3684 36.5039 19.9329 36.5039 19.9329H36.4998Z"
                                        fill="white" />
                                </g>
                                <defs>
                                    <clipPath id="clip0_4982_11701">
                                        <rect width="31" height="34.965" fill="white" transform="translate(5.5 4.5)" />
                                    </clipPath>
                                </defs>
                            </svg>
                        </div>
                    </a>`;
            }
        }
        exibirMenuLateral();

        function limparSessao() {
            sessionStorage.clear();
            window.location = "../login.html"
        }

    </script>
</body>

</html>